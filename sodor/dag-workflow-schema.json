{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://dag-workflow.io/schema/v1/workflow.json",
    "title": "DAG Workflow Protocol Schema",
    "description": "DAG Workflow Protocol JSON Schema Definition",
    "definitions": {
        "name": {
            "type": "string",
            "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$",
            "minLength": 1,
            "maxLength": 63,
            "description": "Name conforming to DNS-1123 specification"
        },
        "duration": {
            "type": "string",
            "pattern": "^([0-9]+d)?([0-9]+h)?([0-9]+m)?([0-9]+s)?$",
            "description": "Duration format, e.g. 30s, 5m, 2h, 1d, 1h30m",
            "examples": [
                "30s",
                "5m",
                "2h",
                "1d",
                "1h30m"
            ]
        },
        "templateVariable": {
            "type": "string",
            "pattern": ".*\\{\\{.*\\}\\}.*",
            "description": "String containing template variables, e.g. {{workflow.parameters.xxx}}"
        },
        "metadata": {
            "type": "object",
            "properties": {
                "name": {
                    "$ref": "#/definitions/name",
                    "description": "Resource name, must be unique"
                },
                "namespace": {
                    "type": "string",
                    "default": "default",
                    "description": "Namespace for resource isolation"
                },
                "labels": {
                    "type": "object",
                    "additionalProperties": {
                        "type": "string"
                    },
                    "description": "Labels for classification and filtering"
                },
                "annotations": {
                    "type": "object",
                    "additionalProperties": {
                        "type": "string"
                    },
                    "description": "Annotations for storing additional metadata"
                }
            },
            "required": [
                "name"
            ],
            "additionalProperties": false
        },
        "parameter": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string",
                    "minLength": 1,
                    "description": "Parameter name"
                },
                "value": {
                    "oneOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "number"
                        },
                        {
                            "type": "boolean"
                        },
                        {
                            "type": "object"
                        },
                        {
                            "type": "array"
                        }
                    ],
                    "description": "Parameter value"
                },
                "default": {
                    "oneOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "number"
                        },
                        {
                            "type": "boolean"
                        },
                        {
                            "type": "object"
                        },
                        {
                            "type": "array"
                        }
                    ],
                    "description": "Default value"
                },
                "description": {
                    "type": "string",
                    "description": "Parameter description"
                },
                "enum": {
                    "type": "array",
                    "items": {
                        "oneOf": [
                            {
                                "type": "string"
                            },
                            {
                                "type": "number"
                            }
                        ]
                    },
                    "description": "Enumeration of allowed values"
                },
                "valueFrom": {
                    "$ref": "#/definitions/valueFrom",
                    "description": "Value source"
                }
            },
            "required": [
                "name"
            ],
            "additionalProperties": false
        },
        "valueFrom": {
            "type": "object",
            "properties": {
                "path": {
                    "type": "string",
                    "description": "Read value from file path"
                },
                "parameter": {
                    "type": "string",
                    "description": "Reference value from another parameter"
                },
                "expression": {
                    "type": "string",
                    "description": "Compute value via expression"
                },
                "secretKeyRef": {
                    "type": "object",
                    "properties": {
                        "name": {
                            "type": "string"
                        },
                        "key": {
                            "type": "string"
                        }
                    },
                    "required": [
                        "name",
                        "key"
                    ],
                    "description": "Reference value from a Secret"
                }
            },
            "additionalProperties": false
        },
        "artifact": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string",
                    "minLength": 1,
                    "description": "Artifact name"
                },
                "path": {
                    "type": "string",
                    "description": "Path of the artifact inside the container"
                },
                "from": {
                    "type": "string",
                    "description": "Reference an artifact from another task"
                },
                "source": {
                    "$ref": "#/definitions/artifactSource",
                    "description": "Artifact source"
                },
                "archive": {
                    "type": "object",
                    "properties": {
                        "type": {
                            "type": "string",
                            "enum": [
                                "tar",
                                "tar.gz",
                                "zip",
                                "none"
                            ],
                            "default": "tar.gz"
                        }
                    },
                    "description": "Archive configuration"
                }
            },
            "required": [
                "name"
            ],
            "additionalProperties": false
        },
        "artifactSource": {
            "type": "object",
            "properties": {
                "type": {
                    "type": "string",
                    "enum": [
                        "oss",
                        "http"
                    ],
                    "description": "Storage type"
                },
                "bucket": {
                    "type": "string",
                    "description": "Bucket name"
                },
                "key": {
                    "type": "string",
                    "description": "Object key/path"
                },
                "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "HTTP URL"
                }
            },
            "required": [
                "type"
            ],
            "additionalProperties": false
        },
        "arguments": {
            "type": "object",
            "properties": {
                "parameters": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/parameter"
                    },
                    "description": "Parameter list"
                },
                "artifacts": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/artifact"
                    },
                    "description": "Artifact list"
                }
            },
            "additionalProperties": false
        },
        "inputs": {
            "type": "object",
            "properties": {
                "parameters": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/parameter"
                    },
                    "description": "Input parameter list"
                },
                "artifacts": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/artifact"
                    },
                    "description": "Input artifact list"
                }
            },
            "additionalProperties": false
        },
        "outputs": {
            "type": "object",
            "properties": {
                "parameters": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/parameter"
                    },
                    "description": "Output parameter list"
                },
                "artifacts": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/artifact"
                    },
                    "description": "Output artifact list"
                }
            },
            "additionalProperties": false
        },
        "retryStrategy": {
            "type": "object",
            "properties": {
                "limit": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 100,
                    "default": 0,
                    "description": "Maximum number of retries"
                },
                "retryOn": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "enum": [
                            "timeout",
                            "transient-error",
                            "network-error",
                            "error",
                            "always"
                        ]
                    },
                    "description": "Error types that trigger a retry"
                },
                "backoff": {
                    "$ref": "#/definitions/backoff",
                    "description": "Backoff strategy"
                },
                "expression": {
                    "type": "string",
                    "description": "Custom retry condition expression"
                }
            },
            "additionalProperties": false
        },
        "backoff": {
            "type": "object",
            "properties": {
                "duration": {
                    "$ref": "#/definitions/duration",
                    "default": "1s",
                    "description": "Initial wait duration"
                },
                "factor": {
                    "type": "number",
                    "minimum": 1,
                    "maximum": 10,
                    "default": 2,
                    "description": "Exponential factor"
                },
                "maxDuration": {
                    "$ref": "#/definitions/duration",
                    "default": "1m",
                    "description": "Maximum wait duration"
                }
            },
            "additionalProperties": false
        },
        "continueOn": {
            "type": "object",
            "properties": {
                "failed": {
                    "type": "boolean",
                    "default": false,
                    "description": "Whether to continue when the task fails"
                },
                "error": {
                    "type": "boolean",
                    "default": false,
                    "description": "Whether to continue when the task errors"
                }
            },
            "additionalProperties": false
        },
        "resources": {
            "type": "object",
            "properties": {
                "cpu": {
                    "oneOf": [
                        {
                            "type": "string",
                            "pattern": "^[0-9]+m?$"
                        },
                        {
                            "type": "number"
                        }
                    ],
                    "description": "CPU resource, e.g. '100m' or '1'"
                },
                "memory": {
                    "type": "string",
                    "pattern": "^[0-9]+(Ki|Mi|Gi|Ti)?$",
                    "description": "Memory resource, e.g. '256Mi', '1Gi'"
                },
                "gpu": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Number of GPUs"
                }
            },
            "additionalProperties": false
        },
        "executor": {
            "type": "object",
            "properties": {
                "type": {
                    "type": "string",
                    "enum": [
                        "http",
                        "container",
                        "script",
                        "function"
                    ],
                    "description": "Executor type"
                },
                "config": {
                    "oneOf": [
                        {
                            "$ref": "#/definitions/httpConfig"
                        },
                        {
                            "$ref": "#/definitions/containerConfig"
                        },
                        {
                            "$ref": "#/definitions/scriptConfig"
                        },
                        {
                            "$ref": "#/definitions/functionConfig"
                        }
                    ],
                    "description": "Executor configuration"
                }
            },
            "required": [
                "type",
                "config"
            ],
            "additionalProperties": false
        },
        "httpConfig": {
            "type": "object",
            "properties": {
                "method": {
                    "type": "string",
                    "enum": [
                        "GET",
                        "POST",
                        "PUT",
                        "DELETE",
                        "PATCH"
                    ],
                    "default": "GET",
                    "description": "HTTP method"
                },
                "url": {
                    "type": "string",
                    "description": "Request URL"
                },
                "headers": {
                    "type": "object",
                    "additionalProperties": {
                        "type": "string"
                    },
                    "description": "Request headers"
                },
                "body": {
                    "oneOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "object"
                        }
                    ],
                    "description": "Request body"
                },
                "timeout": {
                    "$ref": "#/definitions/duration",
                    "default": "30s",
                    "description": "Request timeout"
                },
                "successCondition": {
                    "type": "string",
                    "default": "response.status >= 200 && response.status < 300",
                    "description": "Success condition expression"
                }
            },
            "required": [
                "url"
            ],
            "additionalProperties": false
        },
        "containerConfig": {
            "type": "object",
            "properties": {
                "image": {
                    "type": "string",
                    "description": "Container image"
                },
                "command": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "Container command"
                },
                "args": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "Command arguments"
                },
                "env": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/envVar"
                    },
                    "description": "Environment variables"
                },
                "workingDir": {
                    "type": "string",
                    "description": "Working directory"
                }
            },
            "required": [
                "image"
            ],
            "additionalProperties": false
        },
        "envVar": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string",
                    "description": "Environment variable name"
                },
                "value": {
                    "type": "string",
                    "description": "Environment variable value"
                },
                "valueFrom": {
                    "$ref": "#/definitions/valueFrom",
                    "description": "Value source"
                }
            },
            "required": [
                "name"
            ],
            "additionalProperties": false
        },
        "scriptConfig": {
            "type": "object",
            "properties": {
                "runtime": {
                    "type": "string",
                    "enum": [
                        "python3",
                        "nodejs",
                        "bash",
                        "sh"
                    ],
                    "description": "Script runtime"
                },
                "source": {
                    "type": "string",
                    "description": "Script source code"
                }
            },
            "required": [
                "runtime",
                "source"
            ],
            "additionalProperties": false
        },
        "functionConfig": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string",
                    "enum": [
                        "file-transfer",
                        "file-download",
                        "file-upload",
                        "notify",
                        "sleep"
                    ],
                    "description": "Built-in function name"
                },
                "arguments": {
                    "type": "object",
                    "additionalProperties": true,
                    "description": "Function arguments"
                }
            },
            "required": [
                "name"
            ],
            "additionalProperties": false
        },
        "suspendSpec": {
            "type": "object",
            "properties": {
                "duration": {
                    "$ref": "#/definitions/duration",
                    "description": "Auto-resume duration; manual resume required if not set"
                },
                "message": {
                    "type": "string",
                    "description": "Message displayed to the approver"
                },
                "condition": {
                    "type": "string",
                    "description": "Auto-resume when the condition is met"
                }
            },
            "additionalProperties": false
        },
        "task": {
            "type": "object",
            "properties": {
                "name": {
                    "$ref": "#/definitions/name",
                    "description": "Task name, unique within the DAG"
                },
                "template": {
                    "type": "string",
                    "description": "Referenced template name"
                },
                "dependencies": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "default": [],
                    "description": "List of prerequisite task names"
                },
                "arguments": {
                    "$ref": "#/definitions/arguments",
                    "description": "Arguments passed to the template"
                },
                "when": {
                    "type": "string",
                    "description": "Condition expression; task executes only when evaluated to true"
                },
                "continueOn": {
                    "$ref": "#/definitions/continueOn",
                    "description": "Continue-on conditions"
                },
                "withItems": {
                    "type": "array",
                    "items": {
                        "oneOf": [
                            {
                                "type": "string"
                            },
                            {
                                "type": "number"
                            },
                            {
                                "type": "object"
                            }
                        ]
                    },
                    "description": "Loop execution with a static list"
                },
                "withParam": {
                    "type": "string",
                    "description": "Loop execution with a dynamic parameter reference"
                }
            },
            "required": [
                "name",
                "template"
            ],
            "additionalProperties": false
        },
        "dagSpec": {
            "type": "object",
            "properties": {
                "tasks": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/task"
                    },
                    "minItems": 1,
                    "description": "Task list"
                },
                "failFast": {
                    "type": "boolean",
                    "default": true,
                    "description": "Fail fast; stop subsequent tasks if any task fails"
                }
            },
            "required": [
                "tasks"
            ],
            "additionalProperties": false
        },
        "template": {
            "type": "object",
            "properties": {
                "name": {
                    "$ref": "#/definitions/name",
                    "description": "Template name"
                },
                "inputs": {
                    "$ref": "#/definitions/inputs",
                    "description": "Input definitions"
                },
                "outputs": {
                    "$ref": "#/definitions/outputs",
                    "description": "Output definitions"
                },
                "dag": {
                    "$ref": "#/definitions/dagSpec",
                    "description": "DAG definition (DAG template)"
                },
                "executor": {
                    "$ref": "#/definitions/executor",
                    "description": "Executor configuration (task template)"
                },
                "suspend": {
                    "$ref": "#/definitions/suspendSpec",
                    "description": "Suspend configuration (suspend template)"
                },
                "queue": {
                    "type": "string",
                    "description": "Queue name (required for task templates)"
                },
                "timeout": {
                    "$ref": "#/definitions/duration",
                    "description": "Task timeout"
                },
                "retryStrategy": {
                    "$ref": "#/definitions/retryStrategy",
                    "description": "Retry strategy"
                },
                "resources": {
                    "$ref": "#/definitions/resources",
                    "description": "Resource requirements"
                }
            },
            "required": [
                "name"
            ],
            "oneOf": [
                {
                    "required": [
                        "dag"
                    ],
                    "not": {
                        "required": [
                            "executor",
                            "suspend",
                            "queue"
                        ]
                    }
                },
                {
                    "required": [
                        "executor",
                        "queue"
                    ],
                    "not": {
                        "required": [
                            "dag",
                            "suspend"
                        ]
                    }
                },
                {
                    "required": [
                        "suspend"
                    ],
                    "not": {
                        "required": [
                            "dag",
                            "executor",
                            "queue"
                        ]
                    }
                }
            ],
            "additionalProperties": false
        },
        "hooks": {
            "type": "object",
            "properties": {
                "onStart": {
                    "$ref": "#/definitions/hookSpec",
                    "description": "Triggered when the workflow starts"
                },
                "onSuccess": {
                    "$ref": "#/definitions/hookSpec",
                    "description": "Triggered when the workflow succeeds"
                },
                "onFailure": {
                    "$ref": "#/definitions/hookSpec",
                    "description": "Triggered when the workflow fails"
                },
                "onExit": {
                    "$ref": "#/definitions/hookSpec",
                    "description": "Triggered when the workflow exits (regardless of success or failure)"
                }
            },
            "additionalProperties": false
        },
        "hookSpec": {
            "type": "object",
            "properties": {
                "template": {
                    "type": "string",
                    "description": "Hook template name"
                },
                "arguments": {
                    "$ref": "#/definitions/arguments",
                    "description": "Arguments passed to the template"
                }
            },
            "required": [
                "template"
            ],
            "additionalProperties": false
        },
        "workflowSpec": {
            "type": "object",
            "properties": {
                "entrypoint": {
                    "type": "string",
                    "description": "Entrypoint template name"
                },
                "arguments": {
                    "$ref": "#/definitions/arguments",
                    "description": "Workflow-level arguments"
                },
                "globalTimeout": {
                    "$ref": "#/definitions/duration",
                    "default": "1h",
                    "description": "Global timeout"
                },
                "retryStrategy": {
                    "$ref": "#/definitions/retryStrategy",
                    "description": "Global retry strategy"
                },
                "priority": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 1000,
                    "default": 500,
                    "description": "Priority"
                },
                "queueQuota": {
                    "type": "object",
                    "additionalProperties": {
                        "type": "integer",
                        "minimum": 1
                    },
                    "description": "Queue quota limits"
                },
                "failurePolicy": {
                    "type": "string",
                    "enum": [
                        "fail-fast",
                        "continue"
                    ],
                    "default": "fail-fast",
                    "description": "Failure policy"
                },
                "maxNestedDepth": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 10,
                    "default": 3,
                    "description": "Maximum nesting depth"
                },
                "templates": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/template"
                    },
                    "minItems": 1,
                    "description": "Template definition list"
                },
                "hooks": {
                    "$ref": "#/definitions/hooks",
                    "description": "Lifecycle hooks"
                },
                "workflowTemplateRef": {
                    "$ref": "#/definitions/workflowTemplateRef",
                    "description": "Reference to an external template"
                }
            },
            "oneOf": [
                {
                    "required": [
                        "entrypoint",
                        "templates"
                    ],
                    "not": {
                        "required": [
                            "workflowTemplateRef"
                        ]
                    }
                },
                {
                    "required": [
                        "workflowTemplateRef"
                    ],
                    "not": {
                        "required": [
                            "entrypoint",
                            "templates"
                        ]
                    }
                }
            ],
            "additionalProperties": false
        },
        "workflowTemplateRef": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string",
                    "description": "Referenced template name"
                },
                "namespace": {
                    "type": "string",
                    "description": "Namespace of the template"
                }
            },
            "required": [
                "name"
            ],
            "additionalProperties": false
        },
        "cronWorkflowSpec": {
            "type": "object",
            "properties": {
                "schedule": {
                    "type": "string",
                    "description": "Cron expression"
                },
                "timezone": {
                    "type": "string",
                    "default": "UTC",
                    "description": "Timezone, e.g. Asia/Shanghai"
                },
                "concurrencyPolicy": {
                    "type": "string",
                    "enum": [
                        "Allow",
                        "Forbid",
                        "Replace"
                    ],
                    "default": "Allow",
                    "description": "Concurrency policy"
                },
                "startingDeadlineSeconds": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Starting deadline in seconds"
                },
                "successfulJobsHistoryLimit": {
                    "type": "integer",
                    "minimum": 0,
                    "default": 3,
                    "description": "Number of successful job histories to retain"
                },
                "failedJobsHistoryLimit": {
                    "type": "integer",
                    "minimum": 0,
                    "default": 1,
                    "description": "Number of failed job histories to retain"
                },
                "suspend": {
                    "type": "boolean",
                    "default": false,
                    "description": "Whether to suspend scheduling"
                },
                "workflowSpec": {
                    "$ref": "#/definitions/workflowSpec",
                    "description": "Workflow specification"
                },
                "workflowMetadata": {
                    "$ref": "#/definitions/metadata",
                    "description": "Metadata template for generated Workflows"
                }
            },
            "required": [
                "schedule",
                "workflowSpec"
            ],
            "additionalProperties": false
        }
    },
    "oneOf": [
        {
            "type": "object",
            "title": "Workflow",
            "description": "One-time execution workflow",
            "properties": {
                "apiVersion": {
                    "type": "string",
                    "const": "dag/v1",
                    "description": "API version"
                },
                "kind": {
                    "type": "string",
                    "const": "Workflow",
                    "description": "Resource kind"
                },
                "metadata": {
                    "$ref": "#/definitions/metadata",
                    "description": "Metadata"
                },
                "spec": {
                    "$ref": "#/definitions/workflowSpec",
                    "description": "Workflow specification"
                }
            },
            "required": [
                "apiVersion",
                "kind",
                "metadata",
                "spec"
            ],
            "additionalProperties": false
        },
        {
            "type": "object",
            "title": "CronWorkflow",
            "description": "Scheduled/periodic execution workflow",
            "properties": {
                "apiVersion": {
                    "type": "string",
                    "const": "dag/v1",
                    "description": "API version"
                },
                "kind": {
                    "type": "string",
                    "const": "CronWorkflow",
                    "description": "Resource kind"
                },
                "metadata": {
                    "$ref": "#/definitions/metadata",
                    "description": "Metadata"
                },
                "spec": {
                    "$ref": "#/definitions/cronWorkflowSpec",
                    "description": "CronWorkflow specification"
                }
            },
            "required": [
                "apiVersion",
                "kind",
                "metadata",
                "spec"
            ],
            "additionalProperties": false
        },
        {
            "type": "object",
            "title": "WorkflowTemplate",
            "description": "Reusable workflow template",
            "properties": {
                "apiVersion": {
                    "type": "string",
                    "const": "dag/v1",
                    "description": "API version"
                },
                "kind": {
                    "type": "string",
                    "const": "WorkflowTemplate",
                    "description": "Resource kind"
                },
                "metadata": {
                    "$ref": "#/definitions/metadata",
                    "description": "Metadata"
                },
                "spec": {
                    "$ref": "#/definitions/workflowSpec",
                    "description": "WorkflowTemplate specification"
                }
            },
            "required": [
                "apiVersion",
                "kind",
                "metadata",
                "spec"
            ],
            "additionalProperties": false
        }
    ]
}