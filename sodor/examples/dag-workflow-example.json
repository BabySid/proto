{
    "apiVersion": "dag/v1",
    "kind": "Workflow",
    "metadata": {
        "name": "ai-video-generation",
        "namespace": "production",
        "labels": {
            "project": "ai-video",
            "team": "content-generation",
            "env": "production"
        },
        "annotations": {
            "description": "Complete AI video generation pipeline including material preprocessing, frame generation, audio synthesis, and video merging",
            "owner": "ai-team@example.com",
            "callback_url": "https://api.example.com/webhook/workflow-complete"
        }
    },
    "spec": {
        "entrypoint": "video-generation-dag",
        "arguments": {
            "parameters": [
                {
                    "name": "source_video_url",
                    "value": "https://cdn.example.com/uploads/source-video.mp4",
                    "description": "Source video URL"
                },
                {
                    "name": "style",
                    "value": "anime",
                    "enum": [
                        "anime",
                        "realistic",
                        "cartoon",
                        "oil-painting"
                    ],
                    "description": "Generation style"
                },
                {
                    "name": "resolution",
                    "value": "1080p",
                    "enum": [
                        "720p",
                        "1080p",
                        "4k"
                    ],
                    "description": "Output resolution"
                },
                {
                    "name": "user_id",
                    "value": "user-12345",
                    "description": "User ID for callback notification"
                }
            ],
            "artifacts": [
                {
                    "name": "style_config",
                    "source": {
                        "type": "oss",
                        "bucket": "ai-configs",
                        "key": "styles/anime-v2.json"
                    }
                }
            ]
        },
        "globalTimeout": "2h",
        "retryStrategy": {
            "limit": 2,
            "backoff": {
                "duration": "30s",
                "factor": 2,
                "maxDuration": "5m"
            }
        },
        "priority": 500,
        "queueQuota": {
            "gpu-render": 5,
            "api-call": 20,
            "file-process": 10
        },
        "failurePolicy": "fail-fast",
        "templates": [
            {
                "name": "video-generation-dag",
                "dag": {
                    "tasks": [
                        {
                            "name": "download-source",
                            "template": "file-transfer-task",
                            "arguments": {
                                "parameters": [
                                    {
                                        "name": "source_url",
                                        "value": "{{workflow.parameters.source_video_url}}"
                                    },
                                    {
                                        "name": "destination",
                                        "value": "oss://workflow-data/{{workflow.uid}}/source.mp4"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "extract-frames",
                            "template": "frame-extraction-task",
                            "dependencies": [
                                "download-source"
                            ],
                            "arguments": {
                                "parameters": [
                                    {
                                        "name": "video_path",
                                        "value": "{{tasks.download-source.outputs.parameters.oss_path}}"
                                    },
                                    {
                                        "name": "fps",
                                        "value": "24"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "extract-audio",
                            "template": "audio-extraction-task",
                            "dependencies": [
                                "download-source"
                            ],
                            "arguments": {
                                "parameters": [
                                    {
                                        "name": "video_path",
                                        "value": "{{tasks.download-source.outputs.parameters.oss_path}}"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "style-transfer",
                            "template": "gpu-style-transfer-task",
                            "dependencies": [
                                "extract-frames"
                            ],
                            "arguments": {
                                "parameters": [
                                    {
                                        "name": "frames_path",
                                        "value": "{{tasks.extract-frames.outputs.parameters.frames_dir}}"
                                    },
                                    {
                                        "name": "style",
                                        "value": "{{workflow.parameters.style}}"
                                    },
                                    {
                                        "name": "resolution",
                                        "value": "{{workflow.parameters.resolution}}"
                                    }
                                ],
                                "artifacts": [
                                    {
                                        "name": "style_config",
                                        "from": "{{workflow.artifacts.style_config}}"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "enhance-audio",
                            "template": "audio-enhance-task",
                            "dependencies": [
                                "extract-audio"
                            ],
                            "arguments": {
                                "parameters": [
                                    {
                                        "name": "audio_path",
                                        "value": "{{tasks.extract-audio.outputs.parameters.audio_path}}"
                                    }
                                ]
                            },
                            "continueOn": {
                                "failed": true
                            }
                        },
                        {
                            "name": "merge-video",
                            "template": "video-merge-task",
                            "dependencies": [
                                "style-transfer",
                                "enhance-audio"
                            ],
                            "when": "{{tasks.style-transfer.status}} == 'SUCCESS'",
                            "arguments": {
                                "parameters": [
                                    {
                                        "name": "frames_path",
                                        "value": "{{tasks.style-transfer.outputs.parameters.output_frames}}"
                                    },
                                    {
                                        "name": "audio_path",
                                        "value": "{{tasks.enhance-audio.status}} == 'SUCCESS' ? {{tasks.enhance-audio.outputs.parameters.enhanced_audio}} : {{tasks.extract-audio.outputs.parameters.audio_path}}"
                                    },
                                    {
                                        "name": "output_path",
                                        "value": "oss://output-videos/{{workflow.uid}}/final.mp4"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "generate-thumbnail",
                            "template": "thumbnail-task",
                            "dependencies": [
                                "merge-video"
                            ],
                            "arguments": {
                                "parameters": [
                                    {
                                        "name": "video_path",
                                        "value": "{{tasks.merge-video.outputs.parameters.video_url}}"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "callback-notify",
                            "template": "webhook-callback-task",
                            "dependencies": [
                                "merge-video",
                                "generate-thumbnail"
                            ],
                            "arguments": {
                                "parameters": [
                                    {
                                        "name": "callback_url",
                                        "value": "{{workflow.annotations.callback_url}}"
                                    },
                                    {
                                        "name": "user_id",
                                        "value": "{{workflow.parameters.user_id}}"
                                    },
                                    {
                                        "name": "video_url",
                                        "value": "{{tasks.merge-video.outputs.parameters.video_url}}"
                                    },
                                    {
                                        "name": "thumbnail_url",
                                        "value": "{{tasks.generate-thumbnail.outputs.parameters.thumbnail_url}}"
                                    }
                                ]
                            }
                        }
                    ],
                    "failFast": true
                }
            },
            {
                "name": "file-transfer-task",
                "queue": "file-process",
                "timeout": "10m",
                "inputs": {
                    "parameters": [
                        {
                            "name": "source_url"
                        },
                        {
                            "name": "destination"
                        }
                    ]
                },
                "outputs": {
                    "parameters": [
                        {
                            "name": "oss_path",
                            "valueFrom": {
                                "path": "/tmp/output.txt"
                            }
                        }
                    ]
                },
                "executor": {
                    "type": "function",
                    "config": {
                        "name": "file-transfer",
                        "arguments": {
                            "source": "{{inputs.parameters.source_url}}",
                            "destination": "{{inputs.parameters.destination}}",
                            "checksum": true
                        }
                    }
                },
                "retryStrategy": {
                    "limit": 3,
                    "retryOn": [
                        "network-error",
                        "timeout"
                    ]
                }
            },
            {
                "name": "frame-extraction-task",
                "queue": "file-process",
                "timeout": "15m",
                "inputs": {
                    "parameters": [
                        {
                            "name": "video_path"
                        },
                        {
                            "name": "fps",
                            "default": "30"
                        }
                    ]
                },
                "outputs": {
                    "parameters": [
                        {
                            "name": "frames_dir",
                            "valueFrom": {
                                "path": "/output/frames_dir.txt"
                            }
                        },
                        {
                            "name": "frame_count",
                            "valueFrom": {
                                "jsonPath": "$.frame_count",
                                "path": "/output/metadata.json"
                            }
                        }
                    ]
                },
                "executor": {
                    "type": "container",
                    "config": {
                        "image": "video-tools:v1.5.0",
                        "command": [
                            "python",
                            "/app/extract_frames.py"
                        ],
                        "args": [
                            "--input",
                            "{{inputs.parameters.video_path}}",
                            "--fps",
                            "{{inputs.parameters.fps}}",
                            "--output-dir",
                            "/output/frames"
                        ],
                        "env": [
                            {
                                "name": "OSS_ACCESS_KEY",
                                "valueFrom": {
                                    "secretKeyRef": {
                                        "name": "oss-credentials",
                                        "key": "access_key"
                                    }
                                }
                            },
                            {
                                "name": "OSS_SECRET_KEY",
                                "valueFrom": {
                                    "secretKeyRef": {
                                        "name": "oss-credentials",
                                        "key": "secret_key"
                                    }
                                }
                            }
                        ]
                    }
                },
                "resources": {
                    "cpu": "2",
                    "memory": "4Gi"
                }
            },
            {
                "name": "audio-extraction-task",
                "queue": "file-process",
                "timeout": "5m",
                "inputs": {
                    "parameters": [
                        {
                            "name": "video_path"
                        }
                    ]
                },
                "outputs": {
                    "parameters": [
                        {
                            "name": "audio_path",
                            "valueFrom": {
                                "path": "/output/audio_path.txt"
                            }
                        }
                    ]
                },
                "executor": {
                    "type": "container",
                    "config": {
                        "image": "video-tools:v1.5.0",
                        "command": [
                            "ffmpeg"
                        ],
                        "args": [
                            "-i",
                            "{{inputs.parameters.video_path}}",
                            "-vn",
                            "-acodec",
                            "pcm_s16le",
                            "/output/audio.wav"
                        ]
                    }
                },
                "resources": {
                    "cpu": "1",
                    "memory": "2Gi"
                }
            },
            {
                "name": "gpu-style-transfer-task",
                "queue": "gpu-render",
                "timeout": "45m",
                "inputs": {
                    "parameters": [
                        {
                            "name": "frames_path"
                        },
                        {
                            "name": "style"
                        },
                        {
                            "name": "resolution"
                        }
                    ],
                    "artifacts": [
                        {
                            "name": "style_config",
                            "path": "/config/style.json"
                        }
                    ]
                },
                "outputs": {
                    "parameters": [
                        {
                            "name": "output_frames",
                            "valueFrom": {
                                "path": "/output/frames_path.txt"
                            }
                        }
                    ],
                    "artifacts": [
                        {
                            "name": "processed_frames",
                            "path": "/output/frames",
                            "archive": {
                                "type": "tar.gz"
                            }
                        }
                    ]
                },
                "executor": {
                    "type": "container",
                    "config": {
                        "image": "ai-style-transfer:v3.2.1",
                        "command": [
                            "python",
                            "main.py"
                        ],
                        "args": [
                            "--input-dir",
                            "{{inputs.parameters.frames_path}}",
                            "--style",
                            "{{inputs.parameters.style}}",
                            "--resolution",
                            "{{inputs.parameters.resolution}}",
                            "--config",
                            "/config/style.json",
                            "--output-dir",
                            "/output/frames"
                        ],
                        "env": [
                            {
                                "name": "CUDA_VISIBLE_DEVICES",
                                "value": "0"
                            },
                            {
                                "name": "MODEL_CACHE_DIR",
                                "value": "/models"
                            }
                        ]
                    }
                },
                "resources": {
                    "cpu": "4",
                    "memory": "16Gi",
                    "gpu": 1,
                    "gpuType": "nvidia-a100"
                },
                "retryStrategy": {
                    "limit": 2,
                    "retryOn": [
                        "transient-error"
                    ],
                    "backoff": {
                        "duration": "1m",
                        "factor": 2,
                        "maxDuration": "10m"
                    }
                }
            },
            {
                "name": "audio-enhance-task",
                "queue": "gpu-render",
                "timeout": "10m",
                "inputs": {
                    "parameters": [
                        {
                            "name": "audio_path"
                        }
                    ]
                },
                "outputs": {
                    "parameters": [
                        {
                            "name": "enhanced_audio",
                            "valueFrom": {
                                "path": "/output/enhanced_path.txt"
                            }
                        }
                    ]
                },
                "executor": {
                    "type": "container",
                    "config": {
                        "image": "audio-enhance:v2.0.0",
                        "command": [
                            "python",
                            "enhance.py"
                        ],
                        "args": [
                            "--input",
                            "{{inputs.parameters.audio_path}}",
                            "--output",
                            "/output/enhanced.wav"
                        ]
                    }
                },
                "resources": {
                    "cpu": "2",
                    "memory": "8Gi",
                    "gpu": 1
                }
            },
            {
                "name": "video-merge-task",
                "queue": "file-process",
                "timeout": "20m",
                "inputs": {
                    "parameters": [
                        {
                            "name": "frames_path"
                        },
                        {
                            "name": "audio_path"
                        },
                        {
                            "name": "output_path"
                        }
                    ]
                },
                "outputs": {
                    "parameters": [
                        {
                            "name": "video_url",
                            "valueFrom": {
                                "path": "/output/video_url.txt"
                            }
                        }
                    ]
                },
                "executor": {
                    "type": "container",
                    "config": {
                        "image": "video-tools:v1.5.0",
                        "command": [
                            "python",
                            "/app/merge_video.py"
                        ],
                        "args": [
                            "--frames",
                            "{{inputs.parameters.frames_path}}",
                            "--audio",
                            "{{inputs.parameters.audio_path}}",
                            "--output",
                            "{{inputs.parameters.output_path}}"
                        ]
                    }
                },
                "resources": {
                    "cpu": "4",
                    "memory": "8Gi"
                }
            },
            {
                "name": "thumbnail-task",
                "queue": "api-call",
                "timeout": "2m",
                "inputs": {
                    "parameters": [
                        {
                            "name": "video_path"
                        }
                    ]
                },
                "outputs": {
                    "parameters": [
                        {
                            "name": "thumbnail_url",
                            "valueFrom": {
                                "jsonPath": "$.thumbnail_url",
                                "path": "/tmp/response.json"
                            }
                        }
                    ]
                },
                "executor": {
                    "type": "http",
                    "config": {
                        "method": "POST",
                        "url": "https://api.internal.example.com/thumbnail/generate",
                        "headers": {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer {{secrets.internal_api_token}}"
                        },
                        "body": {
                            "video_url": "{{inputs.parameters.video_path}}",
                            "timestamp": "00:00:05",
                            "width": 640,
                            "height": 360
                        },
                        "successCondition": "response.status == 200"
                    }
                }
            },
            {
                "name": "webhook-callback-task",
                "queue": "api-call",
                "timeout": "30s",
                "inputs": {
                    "parameters": [
                        {
                            "name": "callback_url"
                        },
                        {
                            "name": "user_id"
                        },
                        {
                            "name": "video_url"
                        },
                        {
                            "name": "thumbnail_url"
                        }
                    ]
                },
                "executor": {
                    "type": "http",
                    "config": {
                        "method": "POST",
                        "url": "{{inputs.parameters.callback_url}}",
                        "headers": {
                            "Content-Type": "application/json",
                            "X-Webhook-Signature": "{{secrets.webhook_secret}}"
                        },
                        "body": {
                            "event": "workflow.completed",
                            "workflow_id": "{{workflow.uid}}",
                            "workflow_name": "{{workflow.name}}",
                            "user_id": "{{inputs.parameters.user_id}}",
                            "status": "{{workflow.status}}",
                            "result": {
                                "video_url": "{{inputs.parameters.video_url}}",
                                "thumbnail_url": "{{inputs.parameters.thumbnail_url}}"
                            },
                            "timestamp": "{{workflow.finishedAt}}"
                        }
                    }
                },
                "retryStrategy": {
                    "limit": 5,
                    "retryOn": [
                        "network-error",
                        "timeout"
                    ],
                    "backoff": {
                        "duration": "5s",
                        "factor": 2,
                        "maxDuration": "2m"
                    }
                }
            }
        ],
        "hooks": {
            "onStart": {
                "template": "webhook-callback-task",
                "arguments": {
                    "parameters": [
                        {
                            "name": "callback_url",
                            "value": "{{workflow.annotations.callback_url}}"
                        },
                        {
                            "name": "user_id",
                            "value": "{{workflow.parameters.user_id}}"
                        },
                        {
                            "name": "video_url",
                            "value": ""
                        },
                        {
                            "name": "thumbnail_url",
                            "value": ""
                        }
                    ]
                }
            },
            "onFailure": {
                "template": "webhook-callback-task",
                "arguments": {
                    "parameters": [
                        {
                            "name": "callback_url",
                            "value": "{{workflow.annotations.callback_url}}"
                        },
                        {
                            "name": "user_id",
                            "value": "{{workflow.parameters.user_id}}"
                        },
                        {
                            "name": "video_url",
                            "value": ""
                        },
                        {
                            "name": "thumbnail_url",
                            "value": ""
                        }
                    ]
                }
            }
        }
    }
}